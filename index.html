<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>崇華十五期測驗</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 html2canvas 函式庫，用於將結果區塊轉換為圖片 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* ============================================== */
        /* === 整頁捲動與標準寬度設定 (變更為單頁模式) === */
        /* ============================================== */
        html, body {
            margin: 0;
            padding: 0;
            height: auto; /* 允許內容超出視窗並捲動 */
            overflow-y: auto; /* 啟用頁面垂直滾動 */
        }
        body {
            font-family: '標楷體', 'BiauKai', serif; 
            line-height: 1.6;
            background-color: #f4f4f6;
            color: #333;
            /* 讓內容區塊居中 */
            display: flex;
            justify-content: center;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            width: 100%;
            min-height: 90vh; 
            background: #fff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
            
            display: flex;
            flex-direction: column;
        }

        /* 內容區塊 */
        .content-area {
            flex-grow: 1; 
            /* 在單頁模式下，這個區域是整個 container 內的主滾動區 */
        }

        /* ============================================== */
        /* === 圖片尺寸調整 (已縮小) === */
        /* ============================================== */
        /* 限制題目圖片的最大尺寸並置中 */
        .quiz-image-container {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .quiz-image {
            max-width: 300px; /* 限制最大寬度為 300px */
            width: 100%; /* 確保在小螢幕上可以縮小 */
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* ============================================== */
        /* === 選項佈局調整 (新增兩欄響應式佈局) === */
        /* ============================================== */
        /* 選項容器調整為響應式兩行佈局 (兩欄) */
        .options {
            display: flex;
            flex-direction: column; /* 預設在手機上為單欄 (垂直堆疊) */
            gap: 8px; /* 選項之間的垂直間距 */
        }

        /* 選項標籤樣式 */
        .options label {
            display: flex;
            align-items: flex-start; /* 讓選項文字多行時也能對齊 */
            /* 移除 margin-bottom: 8px; 因為已使用 gap */
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.3s, transform 0.1s;
            width: 100%; /* 手機上佔滿寬度 */
        }
        .options label:hover {
            background-color: #e9e9e9;
        }
        
        /* 螢幕寬度大於 640px (sm) 時，切換到兩欄佈局 */
        @media (min-width: 640px) { 
            .options {
                flex-direction: row;
                flex-wrap: wrap; 
                gap: 16px; /* 調整兩欄之間的間距 (水平和垂直) */
            }
            .options label {
                width: calc(50% - 8px); /* 50% 寬度，扣除一半的 gap (16px / 2 = 8px) */
            }
        }
        /* ============================================== */
        /* === 原始樣式 (保持不變) === */
        /* ============================================== */
        
        .header h1 {
            font-size: 2.5em;
            color: #4CAF50;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .section h2 {
            font-size: 1.8em;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
            color: #555;
        }
        /* 題目區塊樣式 */
        .question {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: #fafafa;
            border: 1px solid #ddd;
            transition: box-shadow 0.3s;
        }
        .question:hover {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        /* 錯題和正確答案的視覺回饋樣式 */
        .question.incorrect-border {
            border: 2px solid #d32f2f;
            background-color: #fcebeb;
        }

        .question.correct-border {
            border: 2px solid #388e3c;
            background-color: #e8f5e9;
        }
        
        .options input {
            margin-right: 10px;
            margin-top: 4px; /* 對齊文字基線 */
            flex-shrink: 0; /* 防止輸入框被擠壓 */
            transform: scale(1.2);
        }
        /* 結果顯示樣式 */
        .correct {
            color: #388e3c;
            font-weight: bold;
        }
        .incorrect {
            color: #d32f2f;
            font-weight: bold;
        }
        /* 結果總結區塊的特殊樣式 */
        .result-box-summary {
            text-align: center;
            margin: 30px 0;
            padding: 30px;
            border-radius: 12px;
            background-color: #e8f5e9;
            border: 3px solid #4CAF50;
        }
        #score {
            font-size: 2.5em;
            color: #388e3c;
            margin: 10px 0;
        }
        /* 按鈕基礎樣式優化 */
        button {
            padding: 12px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.3s;
            box-shadow: 0 4px #388e3c;
            margin: 5px;
        }

        button:hover:not(:disabled) {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 6px #388e3c;
        }
        button:active:not(:disabled) {
            transform: translateY(2px);
            box-shadow: 0 2px #388e3c;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        /* 填空題輸入框樣式 */
        .fill-in-the-blank {
            width: 90%;
            max-width: 400px;
            border: 2px solid #ccc;
            padding: 8px;
            border-radius: 5px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        .fill-in-the-blank:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5);
        }
        /* 訊息通知樣式 */
        #message-box {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-20px);
        }
        .message-success {
            background-color: #4CAF50;
        }
        .message-error {
            background-color: #f44336;
        }

        /* 加分題標籤樣式 */
        .bonus-tag {
            display: inline-block;
            padding: 2px 6px;
            margin-left: 5px;
            font-size: 0.7em;
            font-weight: bold;
            color: white;
            background-color: #ff9800;
            border-radius: 4px;
            vertical-align: middle;
        }

        .bonus-tag::before {
            content: '⭐ 加分題';
        }

        /* 提交按鈕群組 (單頁模式下只需要一個提交按鈕) */
        .submit-group {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0; 
            flex-shrink: 0;
        }
        
        /* 針對小螢幕調整邊距 */
        @media (max-width: 640px) {
            .container {
                padding: 15px;
                min-height: 98vh;
            }
            .header h1 {
                font-size: 1.8em;
                margin-bottom: 15px;
            }
        }
        
        /* 圖片儲存的目標區塊：確保有白色背景 */
        #results-analysis {
            /* 讓這個 wrapper 確保有白色背景 */
            background-color: #fff; 
            padding: 0; 
            margin: 0;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header text-center flex-shrink-0">
            <h1>崇華十五期課堂測驗</h1>
        </div>
        
        <!-- 選擇考卷、組別與姓名區塊 (初始顯示) -->
        <div id="selection-container" class="content-area selection-container flex flex-col items-center justify-center text-center">
            <h2 class="text-xl font-bold mb-4">請先選擇你的考卷、組別與姓名</h2>
            <select id="quiz-type-select" class="p-2 mb-4 rounded border border-gray-300 w-full max-w-xs">
                <option value="" disabled selected>請選擇經典科目</option>
                <option value="論語">論語</option>
                <option value="性理">性理</option>
                <option value="道德經">道德經</option>
                <option value="六祖">六祖</option>
            </select>
            <select id="group-select" disabled class="p-2 mb-4 rounded border border-gray-300 w-full max-w-xs">
                <option value="" disabled selected>請選擇組別</option>
            </select>
            <select id="name-select" disabled class="p-2 mb-4 rounded border border-gray-300 w-full max-w-xs">
                <option value="" disabled selected>請選擇姓名</option>
            </select>
            <button id="start-btn" onclick="startQuiz()" disabled>開始測驗</button>
        </div>

        <!-- 測驗題目區塊 / 結果分析區塊 (所有題目一次顯示) -->
        <div id="quiz-container" class="content-area" style="display:none;">
            <!-- 題目內容或結果分析將在這裡動態載入 -->
            <div id="results-analysis">
                <!-- 測驗題目或結果將在這裡 -->
            </div>
            
            <!-- 送出按鈕將在題目載入後動態加入 -->
        </div>
        
        <!-- 移除靜態的 action-buttons-after-submit 區塊，改為動態插入到結果總結下方 -->

    </div>

    <div id="message-box" role="alert" class="hide-on-screenshot"></div>

    <script>
        // ==========================================================
        // *** 必要的配置設定區塊 (請務必修改為您的實際值) ***
        // ==========================================================
        
        console.log('--- 應用程式啟動與配置讀取 ---');
        
        // 1. Google 試算表 ID：
        const SPREADSHEET_ID = '1W8Y5buwLWAeFFU-ejxhez4He8qyUQsy2yQtlIq8wLBs'; 
        console.log('配置: SPREADSHEET_ID 讀取成功。');
        
        // 2. 名單工作表 GID (組別與姓名)：
        const TEAMS_SHEET_GID = '1026036029';
        console.log('配置: TEAMS_SHEET_GID 讀取成功。');

        // 3. Google Apps Script 部署網址：
        // ⚠️ 已經更新為您提供的網址，修復 Failed to fetch 錯誤的關鍵！
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz5cBTIXATv8H5Oq32kkWZag2Vp5oLg8Kg1pmmn0HPhij_JfWEjAqtVHT94oGUT66Sg/exec'; 
        console.log('配置: APPS_SCRIPT_URL (重要: 請檢查此網址是否正確):', APPS_SCRIPT_URL);

        // 4. 測驗工作表 GID 對應：
        const QUIZ_GIDS = {
            '隨堂': '0',
            '論語': '1250135497',
            '性理': '1342680959',
            '道德經': '1246480043',
            '六祖': '1302889740',
        };
        console.log('配置: QUIZ_GIDS 讀取成功。');

        const GOOGLE_SHEET_BASE_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&gid=`;
        const TEAMS_SHEET_URL = `${GOOGLE_SHEET_BASE_URL}${TEAMS_SHEET_GID}`;
        console.log('計算: TEAMS_SHEET_URL:', TEAMS_SHEET_URL);
        
        // 截圖目標的唯一 ID (僅限結果總結區塊)
        const SUMMARY_ID_FOR_CAPTURE = 'summary-for-screenshot';

        // ==========================================================
        // *** 應用程式狀態與 DOM 元素參考 ***
        // ==========================================================
        let quizData = []; 
        let userAnswersState = {}; // 儲存使用者在不同頁面間的作答 { "q1": "A", "q2": "B, C", ... }

        const quizContainer = document.getElementById('quiz-container');
        const selectionContainer = document.getElementById('selection-container');
        const resultsAnalysisDiv = document.getElementById('results-analysis'); // 結果內容的整體 wrapper
        
        let submitBtn = null; 
        
        let selectedQuizType = '';
        let selectedGroup = '';
        let selectedName = '';
        let teamsData = {}; 
        
        console.log('狀態變數初始化完成。');
        // ==========================================================
        // *** 輔助函式：API 呼叫重試、訊息通知與陣列洗牌 ***
        // ==========================================================
        /** 實作 Fisher-Yates 演算法，用於打亂陣列元素順序。*/
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]
                ];
            }
            return array;
        }
        /** 顯示客製化的頂部通知訊息。*/
        function showMessage(message, isError = false) {
            const type = isError ? '錯誤' : '成功/資訊';
            console.log(`[訊息通知] 類型: ${type}, 內容: ${message}`);
            
            const msgBox = document.getElementById('message-box');
            if (!msgBox) return; 

            msgBox.textContent = message;
            msgBox.className = isError ? 'message-box message-error' : 'message-box message-success';
            msgBox.style.display = 'block';
            
            setTimeout(() => {
                msgBox.style.opacity = '1';
                msgBox.style.transform = 'translateY(0)';
            }, 10); 

            setTimeout(() => {
                msgBox.style.opacity = '0';
                msgBox.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    msgBox.style.display = 'none';
                }, 300); 
            }, 4000); 
        }
        /** 輔助函式：帶有指數退避機制的 Fetch 請求。*/
        async function retryFetch(url, options, maxRetries = 3) {
            console.log(`[retryFetch] 嘗試連接 URL: ${url} (最大重試次數: ${maxRetries})`);
            const fetchOptions = { ...options, mode: 'cors' }; // 確保 CORS 模式
            for (let i = 0; i < maxRetries; i++) {
                const attempt = i + 1;
                console.log(`[retryFetch] 嘗試 ${attempt}/${maxRetries}...`);
                try {
                    const response = await fetch(url, fetchOptions);

                    if (response.ok) {
                        console.log(`[retryFetch] 嘗試 ${attempt} 成功，HTTP 狀態碼: ${response.status}`);
                        return response;
                    }
                    
                    // 即使收到非 2xx 狀態碼，如果是 Apps Script 回傳的錯誤，也需要重試
                    const errorDetails = `HTTP Error: ${response.status} ${response.statusText || ''}`;
                    console.warn(`[retryFetch] 嘗試 ${attempt} 失敗，非 2xx 狀態碼: ${errorDetails}`);
                    throw new Error(errorDetails);

                } catch (error) {
                    console.warn(`[retryFetch] 嘗試 ${attempt} 發生錯誤: ${error.name}: ${error.message}`);
                    
                    if (i === maxRetries - 1) {
                        console.error('[retryFetch] 達到最大重試次數，拋出最終錯誤。');
                        throw error;
                    }
                    
                    const delay = Math.pow(2, i) * 1000;
                    console.log(`[retryFetch] 等待 ${delay}ms 後重試...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        // ==========================================================
        // *** 資料處理與事件處理函式 ***
        // ==========================================================
        /** 填充組別下拉選單。*/
        function populateGroups() {
            const quizTypeSelect = document.getElementById('quiz-type-select');
            const groupSelect = document.getElementById('group-select');
            const nameSelect = document.getElementById('name-select');
            
            // 安全檢查：確保所有元素都存在 (修復 TypeError)
            if (!groupSelect || !quizTypeSelect || !nameSelect) {
                console.error('[populateGroups] 無法找到所有必要的下拉選單元素，取消註冊事件。');
                return; 
            }

            while (groupSelect.options.length > 1) {
                groupSelect.remove(1);
            }

            for (const group in teamsData) {
                const option = document.createElement('option');
                option.value = group;
                option.text = group;
                groupSelect.appendChild(option);
            }

            // 註冊事件
            quizTypeSelect.addEventListener('change', handleQuizTypeChange);
            groupSelect.addEventListener('change', handleGroupChange);
            nameSelect.addEventListener('change', handleNameChange);
            
            groupSelect.disabled = false;
        }
        
        /** 從 Google 試算表讀取組別與姓名資料。*/
        async function fetchTeamsData() {
            try {
                const response = await retryFetch(TEAMS_SHEET_URL, { method: 'GET' });
                const text = await response.text();
                const jsonTextMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                if (!jsonTextMatch || jsonTextMatch.length < 2) {
                    throw new Error("無法解析 Google 試算表 JSON 格式。");
                }
                const data = JSON.parse(jsonTextMatch[1]);
                teamsData = {};
                const rows = data.table.rows;
                rows.forEach(row => {
                    const group = row.c[0] && row.c[0].v ? row.c[0].v : null;
                    const name = row.c[1] && row.c[1].v ? row.c[1].v : null;
                    
                    if (group && name && group !== '組別' && name !== '姓名') { 
                        if (!teamsData[group]) {
                            teamsData[group] = [];
                        }
                        teamsData[group].push(name);
                    }
                });
                
                populateGroups();
            } catch (error) {
                console.error('[fetchTeamsData] 載入組別與姓名資料失敗 (致命錯誤):', error);
                selectionContainer.innerHTML = '<p style="color:red; font-weight:bold;">載入組別資料失敗。請確認：<br>1. 試算表 ID 和 GID 是否正確。<br>2. 試算表已設定為「任何知道連結的人都可以檢視」。</p>';
                showMessage('載入名單失敗，請檢查設定和連線。', true);
            }
        }
        /** 從 Google 試算表讀取單個工作表的題目資料。*/
        async function fetchQuizData(quizType) {
            try {
                const quizGid = QUIZ_GIDS[quizType];
                if (!quizGid) return [];
                const quizSheetUrl = `${GOOGLE_SHEET_BASE_URL}${quizGid}`;
                
                const response = await retryFetch(quizSheetUrl, { method: 'GET' });
                const text = await response.text();
                const jsonTextMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                if (!jsonTextMatch || jsonTextMatch.length < 2) {
                    throw new Error("無法解析 Google 試算表 JSON 格式。");
                }
                const data = JSON.parse(jsonTextMatch[1]);
                const questions = [];
                const rows = data.table.rows;
                rows.forEach((row) => {
                    const cells = row.c;
                    const type = cells[1] && cells[1].v ? cells[1].v.toLowerCase().trim() : ''; 
                    const answerValue = cells[3] && cells[3].v !== undefined ? String(cells[3].v) : ''; 
                    const answer = answerValue ? answerValue.split(',').map(item => item.trim()) : [];
                    
                    if (cells[0] && ['single', 'multiple', 'fill'].includes(type) && answer.length > 0) {
                        questions.push({ 
                            question: cells[0].v,
                            type, 
                            options: cells[2] && cells[2].v ? String(cells[2].v).split(',').map(item => item.trim()) : [],
                            answer, 
                            score: cells[4] && cells[4].v ? parseFloat(cells[4].v) : 0,
                            imageUrl: cells[5] && cells[5].v ? cells[5].v : '',
                            isBonus: cells[6] && cells[6].v && cells[6].v.toString().trim().toLowerCase() !== '否' && cells[6].v.toString().trim() !== '0'
                        });
                    } 
                });
                return questions;
            } catch (error) {
                console.error(`[fetchQuizData] 載入 '${quizType}' 測驗資料失敗:`, error);
                showMessage(`載入 '${quizType}' 測驗資料失敗。`, true);
                return [];
            }
        }
        /** 合併隨堂測驗和選擇的經典科目測驗題目。*/
        async function fetchCombinedQuizData() {
            const [mandatoryQuiz, optionalQuiz] = await Promise.all([
                fetchQuizData('隨堂'), 
                fetchQuizData(selectedQuizType) 
            ]);
            
            // 題目順序不變 (不進行 shuffle)
            quizData = [...mandatoryQuiz, ...optionalQuiz]; 
            
            if (quizData.length > 0) {
                renderAllQuestions();
            } else {
                resultsAnalysisDiv.innerHTML = '<div class="loading-text" style="color:#d32f2f;">無法載入任何題目。</div>';
            }
        }

        // --- 選擇事件處理 ---
        function handleQuizTypeChange(e) {
            selectedQuizType = e.target.value;
            document.getElementById('group-select').disabled = false;
            checkStartButton();
        }

        function handleGroupChange(e) {
            selectedGroup = e.target.value;
            populateNames(selectedGroup);
            checkStartButton();
        }

        function handleNameChange(e) {
            selectedName = e.target.value;
            checkStartButton();
        }

        function populateNames(group) {
            const nameSelect = document.getElementById('name-select');
            nameSelect.innerHTML = '<option value="" disabled selected>請選擇姓名</option>';
            selectedName = ''; 

            if (teamsData[group]) {
                teamsData[group].forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.text = name;
                    nameSelect.appendChild(option);
                });
                nameSelect.disabled = false;
            } else {
                nameSelect.disabled = true;
            }
        }

        function checkStartButton() {
            const startBtn = document.getElementById('start-btn');
            const isReady = selectedQuizType && selectedGroup && selectedName;
            startBtn.disabled = !isReady;
        }

        // ==========================================================
        // *** 單頁全卷渲染核心 (選項亂序) ***
        // ==========================================================

        /** 啟動測驗流程：隱藏選擇區，載入題目數據。*/
        function startQuiz() {
            // 隱藏選擇區塊
            selectionContainer.style.display = 'none';
            
            // 顯示題目區塊
            quizContainer.style.display = 'block';
            resultsAnalysisDiv.innerHTML = '<div class="loading-text text-center text-lg text-gray-600 p-8">正在從 Google 試算表載入題目...請稍候。</div>';
            
            // 清理狀態
            userAnswersState = {}; 
            
            fetchCombinedQuizData();
        }

        /** 渲染所有測驗題目到單一頁面。*/
        function renderAllQuestions() {
            let allQuizHTML = '';
            
            // 1. 顯示總題目數
            const totalQuestions = quizData.length;
            const quizTypeDisplay = document.getElementById('quiz-type-select').value;
            allQuizHTML += `
                <div class="mb-6 p-4 bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800 rounded">
                    <p class="font-bold text-lg">考卷類型：隨堂 + ${quizTypeDisplay}</p>
                    <p>本次測驗共 ${totalQuestions} 題，請仔細作答並捲動至底部提交。</p>
                </div>
            `;


            // 2. 渲染所有題目
            quizData.forEach((item, index) => {
                const questionNumber = index + 1;
                const qId = `q${questionNumber}`;
                const inputType = item.type === 'single' ? 'radio' : 'checkbox';
                const bonusTag = item.isBonus ? '<span class="bonus-tag"></span>' : '';

                // *** 調整圖片尺寸與置中 ***
                let imageHTML = '';
                if (item.imageUrl) {
                    imageHTML = `
                        <div class="quiz-image-container">
                            <img src="${item.imageUrl}" alt="題目圖片" 
                                 onerror="this.onerror=null; this.src='https://placehold.co/300x150/ffcccc/c00000?text=圖片載入失敗！';" 
                                 class="quiz-image">
                        </div>`;
                }

                if (item.type === 'single' || item.type === 'multiple') {
                    let optionsHTML = '';
                    
                    // *** 關鍵變動：打亂選項順序 ***
                    // 複製並打亂選項陣列，以實現選項亂序
                    const optionsToRender = shuffleArray([...item.options]); 

                    optionsToRender.forEach((option) => {
                        optionsHTML += `
                            <label>
                                <input type="${inputType}" name="${qId}" value="${option}"> 
                                <span>${option}</span>
                            </label>`;
                    });
                    allQuizHTML += `
                        <div class="question" id="${qId}">
                            <p class="text-xl font-medium">${questionNumber}. ${item.question} <span style="font-size: 0.8em; color: #888;">(${item.score}分)</span> ${bonusTag}</p>
                            ${imageHTML}
                            <div class="options" data-type="${item.type}" data-qid="${qId}">
                                ${optionsHTML}
                            </div>
                        </div>
                    `;
                } else if (item.type === 'fill') {
                    allQuizHTML += `
                        <div class="question" id="${qId}">
                            <p class="text-xl font-medium">${questionNumber}. ${item.question} <span style="font-size: 0.8em; color: #888;">(${item.score}分)</span> ${bonusTag}</p>
                            ${imageHTML}
                            <input type="text" class="fill-in-the-blank mt-2" data-qid="${qId}" placeholder="請在此輸入答案">
                        </div>
                    `;
                }
            });

            // 3. 加入提交按鈕和底部訊息
            allQuizHTML += `
                <div class="submit-group" id="initial-submit-group">
                    <button id="submit-btn" onclick="submitAnswers()">送出答案 (共 ${totalQuestions} 題)</button>
                </div>
            `;

            resultsAnalysisDiv.innerHTML = allQuizHTML;
            
            // 取得提交按鈕的參考
            submitBtn = document.getElementById('submit-btn'); 

            // 滾動到頁面頂部以開始作答
            window.scrollTo(0, 0); 
        }

        /** 遍歷所有題目，收集使用者作答。*/
        function collectAllAnswers() {
            const newAnswers = {};
            
            quizData.forEach((item, index) => {
                const qId = `q${index + 1}`;
                let userAnswerText = '未作答';
                const questionElement = document.getElementById(qId);
                if (!questionElement) return;

                if (item.type === 'single') {
                    const userAnswer = questionElement.querySelector(`input[name="${qId}"]:checked`);
                    userAnswerText = userAnswer ? userAnswer.value.trim() : '未作答';
                } else if (item.type === 'multiple') {
                    const userAnswersArr = Array.from(questionElement.querySelectorAll(`input[name="${qId}"]:checked`))
                                                .map(el => el.value.trim()) 
                                                .sort();
                    userAnswerText = userAnswersArr.join(', ') || '未作答';
                } else if (item.type === 'fill') {
                    const userAnswerInput = questionElement.querySelector('.fill-in-the-blank');
                    const userAnswerNormalized = userAnswerInput ? userAnswerInput.value.trim() : '';
                    userAnswerText = userAnswerNormalized || '未作答';
                }
                newAnswers[qId] = userAnswerText;
            });
            userAnswersState = newAnswers;
            console.log('[collectAllAnswers] 收集到的答案:', userAnswersState);
        }

        // ==========================================================
        // *** 答案提交與結果顯示 ***
        // ==========================================================

        /** 整理 userAnswersState 為 Apps Script 預期的格式。*/
        function prepareAnswersForSubmission() {
            const submissionAnswers = [];
            
            // 確保收集到所有答案
            collectAllAnswers();

            // 遍歷所有題目
            quizData.forEach((item, index) => {
                const qId = `q${index + 1}`;
                submissionAnswers.push({
                    qId: qId,
                    userAnswer: userAnswersState[qId] || '未作答', // 從狀態中取答案
                });
            });
            return submissionAnswers;
        }
        
        /** 傳送答案和題目資料給 Apps Script 進行計分和寫入。*/
        async function sendAnswersToGoogleSheet(userAnswers) {
            const quizTypeDisplay = document.getElementById('quiz-type-select').value;

            const dataToSend = {
                group: selectedGroup,
                name: selectedName,
                quizType: quizTypeDisplay,
                userAnswersJson: JSON.stringify(userAnswers),
                quizDataJson: JSON.stringify(quizData)
            };
            
            const formBody = Object.keys(dataToSend).map(key => 
                encodeURIComponent(key) + '=' + encodeURIComponent(dataToSend[key])
            ).join('&');

            try {
                const response = await retryFetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    // mode: 'cors' 已在 retryFetch 中確保
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' 
                    },
                    body: formBody
                });
                
                // 由於 Apps Script 通常返回 JSON，我們先嘗試解析 JSON
                const result = await response.json(); 
                
                // Apps Script 後端預期回傳分數細項：
                console.log('[sendAnswersToGoogleSheet] Apps Script 返回結果:', result);

                return result;

            } catch (error) {
                console.error('[sendAnswersToGoogleSheet] 致命錯誤: 傳送答案到 Apps Script 失敗:', error);
                showMessage('致命錯誤: 傳送答案到 Apps Script 失敗。請檢查網址或 Apps Script 權限。', true);
                // 拋出包含 Apps Script 相關提示的錯誤，以供前端處理
                return { 
                    status: 'error', 
                    message: `傳輸失敗或網路錯誤: ${error.message}。請確認 Apps Script 已正確部署且權限設定為「任何人」。`, 
                    score: 0, answersDetail: [], mandatoryScore: 0, optionalScore: 0 
                };
            }
        }

        /** 處理「送出答案」按鈕點擊事件，執行計分和結果顯示。*/
        async function submitAnswers() {
            console.log('--- [submitAnswers] 啟動答案提交流程 ---');
            
            submitBtn = document.getElementById('submit-btn'); // 確保取得按鈕參考
            const initialSubmitGroup = document.getElementById('initial-submit-group');

            if (!submitBtn || !initialSubmitGroup) {
                showMessage('提交失敗：缺少必要的提交按鈕元件。', true);
                return;
            }

            const submissionAnswers = prepareAnswersForSubmission();

            // 步驟 1: 禁用介面，準備提交
            submitBtn.disabled = true;
            submitBtn.innerText = '正在傳送與計分...';
            
            // 步驟 2: 傳送答案到 Apps Script
            let submissionResult;

            try {
                submissionResult = await sendAnswersToGoogleSheet(submissionAnswers);
            } catch (error) {
                // 如果 retryFetch 拋出錯誤，這裡會捕獲到
                submissionResult = { status: 'error', score: 0, answersDetail: [], message: error.message, mandatoryScore: 0, optionalScore: 0 };
            }

            // 步驟 3: 處理 Apps Script 的響應結果
            if (submissionResult.status === 'success') {
                showMessage(`答案提交成功！得分: ${submissionResult.score} 分。`, false);
                
                const mandatoryScore = submissionResult.mandatoryScore || 0;
                const optionalScore = submissionResult.optionalScore || 0;
                
                // 隱藏初始提交按鈕群組
                initialSubmitGroup.style.display = 'none';

                // 顯示測驗結果和答案解析
                displayQuizResults(submissionResult.answersDetail, submissionResult.score, mandatoryScore, optionalScore);

            } else {
                showMessage(`提交失敗: ${submissionResult.message}`, true);
                
                // 失敗時，重新啟用按鈕
                submitBtn.innerText = '送出答案';
                submitBtn.disabled = false;
            }
        }

        /**
         * 渲染結果總結、操作按鈕和詳細解析。
         */
        function displayQuizResults(answersDetail, finalScore, mandatoryScore, optionalScore) {
            console.log('[displayQuizResults] 開始標註對錯並顯示答案解析。');
            let wrongQuestionsCount = 0;
            const wrongQuestionNumbers = [];
            
            const quizTypeDisplay = document.getElementById('quiz-type-select').value;
            
            // 遍歷答案細節以計算錯題數和錯題號碼
            answersDetail.forEach((detail, index) => {
                const qNum = index + 1;
                if (!detail.isCorrect) {
                    wrongQuestionsCount++;
                    wrongQuestionNumbers.push(qNum);
                }
            });

            // 準備答錯訊息
            const wrongMsg = wrongQuestionsCount > 0 
                ? `本次測驗共答錯 ${wrongQuestionsCount} 題，題號為：${wrongQuestionNumbers.join('、')}` 
                : '恭喜你！本次測驗全部答對！';
            
            const wrongMsgClass = wrongQuestionsCount > 0 ? 'text-red-700' : 'text-green-700';

            // --- 區塊 1: 測驗解析總結 (用於截圖) ---
            const resultSummaryHTML = `
                <div class="result-box-summary" id="${SUMMARY_ID_FOR_CAPTURE}">
                    <h2 class="text-3xl font-extrabold text-[#4CAF50]">測驗解析總結</h2>
                    <p class="text-xl mt-2">組別：<span class="font-bold">${selectedGroup}</span> | 姓名：<span class="font-bold">${selectedName}</span> </p>
                    
                    <p class="text-lg mt-3 font-semibold">考卷類型: 隨堂 + ${quizTypeDisplay}</p>                    
                    <p class="text-xl mb-4">總得分: <span id="score" class="font-bold text-4xl text-[#388e3c]">${finalScore}</span> 分</p>
                    <p id="wrong-questions" class="text-lg font-bold ${wrongMsgClass}">${wrongMsg}</p>
                </div>
            `;
            
            // --- 區塊 2: 操作按鈕 (中間位置) ---
            // 按鈕動態插入在總結和詳解之間
            const actionButtonsHTML = `
                <div id="action-buttons-after-submit" class="submit-group bg-white p-4 rounded-xl shadow-inner border-t border-b border-gray-100 mb-6 mt-4">
                    <button id="save-image-btn" onclick="saveResultsAsImage()" class="bg-blue-600 hover:bg-blue-700 shadow-blue-800">儲存成績圖片 (僅總結)</button>
                    <button id="restart-btn" onclick="resetQuiz()" class="bg-gray-500 hover:bg-gray-600 shadow-gray-700">重新測驗</button>
                </div>
            `;
            
            // --- 區塊 3: 詳細題目與答案解析 (網頁顯示) ---
            let detailedAnalysisHTML = `
                <div id="detailed-analysis" class="mt-8 border-t-2 border-gray-200 pt-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">詳細題目與答案解析</h2>
            `;

            answersDetail.forEach((detail, index) => {
                const question = quizData[index];
                const qNum = index + 1;
                const isCorrect = detail.isCorrect;
                const resultClass = isCorrect ? 'correct-border' : 'incorrect-border';
                const resultText = isCorrect ? '✓ 答對' : '✗ 答錯';
                const resultColor = isCorrect ? 'text-green-600' : 'text-red-600';

                // 圖片
                let imageHTML = '';
                if (question.imageUrl) {
                    imageHTML = `
                        <div class="quiz-image-container">
                            <img src="${question.imageUrl}" alt="題目圖片" 
                                 onerror="this.onerror=null; this.src='https://placehold.co/300x150/ffcccc/c00000?text=圖片載入失敗！';" 
                                 class="quiz-image">
                        </div>`;
                }

                detailedAnalysisHTML += `
                    <div class="question ${resultClass} p-4 mb-6">
                        <p class="text-xl font-medium mb-2">
                            ${qNum}. ${question.question} 
                            <span class="${resultColor} font-bold ml-2">(${resultText})</span>
                            ${question.isBonus ? '<span class="bonus-tag"></span>' : ''}
                        </p>
                        ${imageHTML}
                        
                        <p class="mt-2 text-base">
                            <span class="font-bold text-gray-700">你的回答:</span> 
                            <span class="${isCorrect ? 'text-green-600' : 'text-red-600'}">
                                ${detail.userAnswer || '未作答'}
                            </span>
                        </p>

                        <p class="mt-1 text-base">
                            <span class="font-bold text-gray-700">正確答案:</span> 
                            <span class="correct">
                                ${question.answer.join(', ')}
                            </span>
                        </p>
                    </div>
                `;
            });

            detailedAnalysisHTML += '</div>';

            // 4. 組合所有結果區塊: 總結 + 按鈕 + 詳解
            resultsAnalysisDiv.innerHTML = resultSummaryHTML + actionButtonsHTML + detailedAnalysisHTML;

            // 滾動到頁面頂部以查看結果總結
            window.scrollTo(0, 0); 
        }

        // ==========================================================
        // *** 圖片儲存功能 (目標鎖定為 SUMMARY_ID_FOR_CAPTURE) ***
        // ==========================================================

        /** 將測驗結果總結區塊轉換為圖片並下載。
         */
        function saveResultsAsImage() {
            // *** 關鍵變動：鎖定 SUMMARY_ID_FOR_CAPTURE 元素 ***
            const targetElement = document.getElementById(SUMMARY_ID_FOR_CAPTURE); 
            const saveBtn = document.getElementById('save-image-btn');

            if (!targetElement) {
                showMessage('錯誤：找不到總結截圖區域。', true);
                return;
            }

            // 禁用按鈕，防止重複點擊
            saveBtn.disabled = true;
            saveBtn.innerText = '正在生成圖片...';

            // html2canvas 核心調用
            html2canvas(targetElement, {
                scale: 2, // 提高解析度 (Retina 螢幕適用)
                logging: false,
                useCORS: true, // 如果題目有外部圖片，需要設定
                backgroundColor: '#ffffff', // 確保截圖背景為白色
            }).then(canvas => {
                try {
                    // 獲取圖片數據 URL
                    const imageURL = canvas.toDataURL('image/png');
                    
                    // 創建一個虛擬的下載連結
                    const a = document.createElement('a');
                    const fileName = `${selectedGroup}_${selectedName}_${selectedQuizType}_成績.png`;
                    a.href = imageURL;
                    a.download = fileName;
                    
                    // 模擬點擊下載
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    showMessage(`成績圖片 (${fileName}) 已成功儲存！`);

                } catch (error) {
                    console.error('儲存圖片失敗:', error);
                    showMessage('儲存圖片失敗。可能的原因：外部圖片跨域問題或瀏覽器限制。', true);
                } finally {
                    // 恢復按鈕狀態
                    saveBtn.disabled = false;
                    saveBtn.innerText = '儲存成績圖片 (僅總結)';
                }
            }).catch(error => {
                console.error('HTML 轉 Canvas 失敗:', error);
                showMessage('圖片生成失敗，請檢查控制台錯誤訊息。', true);
                saveBtn.disabled = false;
                saveBtn.innerText = '儲存成績圖片 (僅總結)';
            });
        }


        // 4. 重設與初始化
        /**
         * 重設測驗狀態，回到選擇介面。
         */
        function resetQuiz() {
            // 清理狀態
            quizData = [];
            userAnswersState = {};
            selectedQuizType = '';
            selectedGroup = '';
            selectedName = '';
            
            // 重設下拉選單的選擇
            document.getElementById('quiz-type-select').value = '';
            // 由於 populateGroups 會重新填充 groupSelect，這裡只需清空 nameSelect
            document.getElementById('group-select').innerHTML = '<option value="" disabled selected>請選擇組別</option>';
            document.getElementById('name-select').innerHTML = '<option value="" disabled selected>請選擇姓名</option>';

            // 重新啟用和禁用按鈕/選單
            document.getElementById('group-select').disabled = true;
            document.getElementById('name-select').disabled = true;
            document.getElementById('start-btn').disabled = true;
            
            // 清空並隱藏區塊
            resultsAnalysisDiv.innerHTML = '';
            quizContainer.style.display = 'none';

            // 顯示選擇介面
            selectionContainer.style.display = 'flex';
            
            // 重新載入名單資料
            fetchTeamsData(); 
        }

        // 啟動應用程式: 頁面載入完成後執行
        document.addEventListener('DOMContentLoaded', () => {
            fetchTeamsData(); // 載入組別與姓名名單
        });
    </script>
</body>
</html>
